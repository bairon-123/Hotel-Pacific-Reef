<ion-header class="site-header">
  <ion-toolbar color="light">
    <div class="container navbar">
      <div class="brand">
        <ion-icon name="sparkles-outline"></ion-icon>
        <span>Hotel Pacific Reef</span>
      </div>
      <nav class="menu">
        <a routerLink="/home" routerLinkActive="active">Home</a>
        <a routerLink="/reservas" routerLinkActive="active">Reservas</a>
        <a routerLink="/perfil" routerLinkActive="active">Perfil</a>
        <span *ngIf="currentEmail" class="user-pill">Hola, <b>{{ currentEmail }}</b></span>
        <a href="#" class="logout" (click)="logout($event)">Cerrar sesión</a>
      </nav>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="site-content ion-padding">

  <!-- Filtros -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Buscar disponibilidad</ion-card-title>
      <ion-card-subtitle>Mínimo 5 días de anticipación</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content class="filters-grid">
      <ion-item>
        <ion-label position="stacked">Llegada</ion-label>
        <ion-datetime
          [(ngModel)]="llegada"
          [min]="minDate"
          [max]="maxDate"
          presentation="date"
          (ionChange)="onFechaChange()">
        </ion-datetime>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Salida</ion-label>
        <ion-datetime
          [(ngModel)]="salida"
          [min]="minDate"
          [max]="maxDate"
          presentation="date"
          (ionChange)="onFechaChange()">
        </ion-datetime>
      </ion-item>

      <!-- Indicador de política de horas -->
      <ion-text color="medium" class="ion-margin-top">
        Check-in desde <b>14:00</b> • Check-out hasta <b>12:00</b>. El total se cuenta por <b>noches</b>.
      </ion-text>

      <ion-item>
        <ion-label>Tipo de habitación</ion-label>
        <ion-select [(ngModel)]="tipoSeleccionado" (ionChange)="filtrar()">
          <ion-select-option value="">Todas</ion-select-option>
          <ion-select-option value="basic">Básica</ion-select-option>
          <ion-select-option value="medium">Medium</ion-select-option>
          <ion-select-option value="premium">Premium</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label>Solo disponibles</ion-label>
        <ion-toggle [(ngModel)]="soloDisponibles" (ionChange)="filtrar()"></ion-toggle>
      </ion-item>

      <ion-text color="danger" *ngIf="errorMsg">{{ errorMsg }}</ion-text>
      <ion-note *ngIf="!errorMsg && noches > 0">
        Estadía: <b>{{ noches }}</b> {{ noches === 1 ? 'noche' : 'noches' }} (check-in 14:00 / check-out 12:00)
      </ion-note>
    </ion-card-content>
  </ion-card>

  <!-- Lista de habitaciones -->
  <ion-card *ngFor="let h of filtradas">
    <!-- Galería compacta -->
    <div class="gallery">
      <!-- Imagen principal -->
      <img class="hero-img"
           [src]="getCover(h)"
           [alt]="h.nombre"
           (click)="openLightbox(h, getIndex(h))" />

      <!-- Miniaturas -->
      <div class="thumbs" *ngIf="(h.imgs || []).length > 1">
        <button class="thumb"
                *ngFor="let img of (h.imgs || []); index as i"
                [class.active]="getIndex(h) === i"
                (click)="showImg(h, i)"
                type="button"
                aria-label="Ver imagen {{i+1}} de {{h.nombre}}">
          <img [src]="img" [alt]="h.nombre + ' foto ' + (i+1)" />
        </button>
      </div>
    </div>

    <ion-card-header>
      <ion-card-title>{{ h.nombre }}</ion-card-title>
      <ion-card-subtitle>{{ h.camas || '—' }} • Cap: {{ h.capacidad || '—' }}</ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <p>{{ h.descripcion }}</p>

      <div class="price-line">
        <ion-badge color="primary">{{ currency(h.precioNoche) }}/noche</ion-badge>
        <ion-badge color="success" *ngIf="h.disponible">Disponible</ion-badge>
        <ion-badge color="medium" *ngIf="!h.disponible">No disponible</ion-badge>
      </div>

      <div class="amenities" *ngIf="(h.amenities || []).length">
        <ion-chip *ngFor="let a of (h.amenities || [])" color="medium" outline>{{ a }}</ion-chip>
      </div>

      <ion-button
        expand="block"
        color="success"
        [disabled]="!h.disponible || noches <= 0"
        (click)="reservar(h)">
        Reservar
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Lightbox -->
  <ion-modal [isOpen]="lightboxOpen" (didDismiss)="closeLightbox()">
    <div class="lightbox">
      <button class="lb-btn close" (click)="closeLightbox()" aria-label="Cerrar">
        <ion-icon name="close"></ion-icon>
      </button>

      <button class="lb-btn nav prev"
              (click)="prev()"
              [disabled]="lightboxImgs.length <= 1"
              aria-label="Anterior">
        <ion-icon name="chevron-back"></ion-icon>
      </button>

      <button class="lb-btn nav next"
              (click)="next()
              " [disabled]="lightboxImgs.length <= 1"
              aria-label="Siguiente">
        <ion-icon name="chevron-forward"></ion-icon>
      </button>

      <div class="stage" *ngIf="lightboxImgs.length" (click)="toggleZoom()">
        <img [src]="lightboxImgs[lightboxIndex]"
             [alt]="'Imagen '+(lightboxIndex+1)+' de '+lightboxImgs.length"
             [class.zoom]="zoomed" />
      </div>

      <div class="lb-thumbs" *ngIf="lightboxImgs.length > 1">
        <button *ngFor="let img of lightboxImgs; index as i"
                type="button"
                class="thumb"
                [class.active]="i === lightboxIndex"
                (click)="lightboxIndex = i">
          <img [src]="img" [alt]="'Miniatura '+(i+1)" />
        </button>
      </div>
    </div>
  </ion-modal>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>© 2025 Hotel Pacific Reef — Todos los derechos reservados</p>
    </div>
  </footer>
</ion-content>
